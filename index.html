<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Boja Calculator</title>
<style>
  :root{
    --bg:#0a0a0c;
    --panel:#101015;
    --panel2:#14141b;
    --line:#2a2a35;
    --fg:#f2f2f3;
    --muted:#a9a9b3;
    --dealer:#ffd84a;
    --opener:#6bff8a;
    --cellH: 46px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size:13px;
  }
  .wrap{ max-width:100%; margin:0 auto; padding:6px 6px 14px; }

  .topbar{
    position:sticky; top:0; z-index:10;
    margin:-6px -6px 6px;
    padding:6px 6px calc(6px + env(safe-area-inset-top));
    background:linear-gradient(to bottom, rgba(10,10,12,.96), rgba(10,10,12,.78));
    backdrop-filter: blur(12px);
    border-bottom:1px solid rgba(255,255,255,.06);
    display:flex; gap:6px; align-items:center; flex-wrap:wrap;
  }
  .title{ font-weight:950; letter-spacing:.2px; font-size:13px; }
  .pill{
    font-size:10.5px; color:var(--muted);
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    padding:4px 7px;
    border-radius:999px;
    white-space:nowrap;
  }
  .sp{ flex:1; }
  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--fg);
    padding:6px 9px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    user-select:none;
    font-size:11.5px;
  }
  .btn:active{ transform:translateY(1px); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }
  .btn.danger{ border-color: rgba(255,111,111,.35); }

  .card{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    padding:8px;
  }
  .card + .card{ margin-top:6px; }

  .row{ display:flex; gap:6px; align-items:center; flex-wrap:nowrap; }
  .seg{
    display:inline-flex;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:rgba(255,255,255,.03);
  }
  .seg button{
    border:0;
    padding:6px 8px;
    background:transparent;
    color:var(--muted);
    font-weight:950;
    cursor:pointer;
    white-space:nowrap;
    font-size:10.5px;
  }
  .seg button.active{
    color:var(--fg);
    background:rgba(255,255,255,.06);
  }

  .names{
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:6px;
    margin-top:6px;
  }
  input.name{
    width:100%;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--fg);
    border-radius:10px;
    padding:6px 7px;
    font-weight:900;
    outline:none;
    font-size:11.5px;
    min-width:0;
  }

  table{
    width:100%;
    table-layout:fixed;
    border-collapse:separate;
    border-spacing:0;
    margin-top:6px;
    overflow:hidden;
    border:1px solid var(--line);
    border-radius:12px;
    font-size:11.5px;
  }
  th, td{
    border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    padding:5px 3px;
    text-align:center;
    vertical-align:middle;
  }
  tr:last-child td{ border-bottom:0; }
  th:last-child, td:last-child{ border-right:0; }
  th{
    color:var(--muted);
    font-size:10.5px;
    font-weight:950;
    background:rgba(255,255,255,.03);
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  td{ background:rgba(0,0,0,.10); }
  .colN{ width:30px; color:var(--muted); font-weight:950; font-size:10.5px; }

  .dealerCol{ box-shadow: inset 0 0 0 2px rgba(255,216,74,.45); }
  .openerCol{ box-shadow: inset 0 0 0 2px rgba(107,255,138,.40); }

  /* Cell container */
  .cell{
    position:relative;
    height:var(--cellH);
    border-radius:10px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* Real input inside each cell (keyboard always works) */
  .scoreInput{
    width:100%;
    height:100%;
    border:0;
    outline:none;
    background:transparent;
    color:var(--fg);
    font-weight:950;
    font-size:13px;
    text-align:center;
    padding:0;
    margin:0;
    appearance:none;
    -webkit-appearance:none;
  }
  .scoreInput::placeholder{ color:rgba(242,242,243,.18); }

  /* When cell should show circle, we hide input and show circle overlay */
  .circleOverlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .circle{
    width:36px; height:36px;
    border-radius:999px;
    border:2px solid var(--fg);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:950;
    font-size:11px;
  }

  .bidDot{
    position:absolute;
    top:7px; right:7px;
    width:7px; height:7px;
    border-radius:999px;
    background:var(--fg);
    opacity:.95;
    display:none;
    pointer-events:none;
  }

  .disabled{
    opacity:.45;
    pointer-events:none;
  }

  .doneRow td{
    background:rgba(0,0,0,.06);
    padding:5px 6px;
  }
  .doneWrap{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:6px;
  }
  .miniBtn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    color:var(--fg);
    padding:6px 8px;
    border-radius:10px;
    font-weight:950;
    cursor:pointer;
    font-size:11.5px;
  }
  .miniBtn:disabled{ opacity:.45; cursor:not-allowed; }

  .rrow td{
    background:rgba(255,255,255,.03);
    color:var(--muted);
    font-weight:950;
  }
  .rlabel{
    font-weight:980;
    letter-spacing:.3px;
    color:var(--fg);
  }

  .totalsRow{
    margin-top:6px;
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap:6px;
  }
  .tbox{
    background:var(--panel2);
    border:1px solid var(--line);
    border-radius:12px;
    padding:8px 6px;
    min-width:0;
  }
  .tname{
    font-size:10.5px; color:var(--muted); font-weight:950;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .tval{ margin-top:3px; font-size:16px; font-weight:980; }

  .sheetBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:flex-end;
    justify-content:center;
    padding:8px 8px calc(8px + env(safe-area-inset-bottom));
    z-index:50;
  }
  .sheet{
    width:min(100%, calc(100% - 16px));
    background:rgba(20,20,27,.98);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }
  .sheetTitle{ font-weight:980; font-size:14px; }
  .sheetText{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.25; }
  .sheetRow{ display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }

  @media (min-width: 820px){
    .wrap{ max-width:980px; padding:14px 12px 40px; }
    .topbar{ margin:-14px -12px 12px; padding:10px 10px calc(10px + env(safe-area-inset-top)); }
    :root{ --cellH: 54px; }
    table{ margin-top:12px; font-size:inherit; }
    th, td{ padding:10px; }
    .colN{ width:56px; font-size:inherit; }
    .scoreInput{ font-size:16px; }
    .circle{ width:46px; height:46px; font-size:inherit; }
    .totalsRow{ margin-top:12px; gap:10px; }
    .tbox{ padding:12px 10px; border-radius:16px; }
    .tname{ font-size:12px; }
    .tval{ font-size:24px; margin-top:6px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">Boja calculator</div>
    <div class="pill" id="wherePill">G1 • 1/2</div>
    <div class="sp"></div>
    <button class="btn" id="newGameBtn">New</button>
    <button class="btn danger" id="resetBtn">Reset</button>
  </div>

  <div class="card">
    <div class="row">
      <div class="pill">Game</div>
      <div class="seg" id="gameSeg"></div>
      <div class="pill">Half</div>
      <div class="seg">
        <button type="button" id="half1Btn" class="active">1/2</button>
        <button type="button" id="half2Btn">2/2</button>
      </div>
    </div>
    <div class="names" id="names"></div>
  </div>

  <div class="card">
    <table>
      <colgroup>
        <col style="width:30px">
        <col style="width:calc((100% - 30px)/4)">
        <col style="width:calc((100% - 30px)/4)">
        <col style="width:calc((100% - 30px)/4)">
        <col style="width:calc((100% - 30px)/4)">
      </colgroup>
      <thead>
        <tr>
          <th class="colN">#</th>
          <th id="h0">P1</th>
          <th id="h1">P2</th>
          <th id="h2">P3</th>
          <th id="h3">P4</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="totalsRow" id="totals"></div>
  </div>
</div>

<div class="sheetBack" id="resetBack">
  <div class="sheet">
    <div class="sheetTitle">Reset everything?</div>
    <div class="sheetText">This deletes all games and scores on this device.</div>
    <div class="sheetRow">
      <button class="btn" id="cancelReset">Cancel</button>
      <button class="btn danger" id="confirmReset">Reset</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  const KEY = "boja_calc_inputs_v1";

  function dealerOf(r){ return (r-1) % 4; }
  function openerOf(r){ return (dealerOf(r)+1) % 4; }

  function makeHalf(){
    return {
      rounds: Array.from({length:11}, () => ({
        values:[null,null,null,null],
        finalized:false,
        bidder:null,
        bidAmount:null
      }))
    };
  }
  function makeGame(){
    return {
      halves: { 1: makeHalf(), 2: makeHalf() },
      orders: { 1: [0,1,2,3], 2: null }
    };
  }
  function defaultState(){
    return {
      players: ["","","",""],
      games: [ makeGame() ],
      viewGame: 0,
      viewHalf: 1
    };
  }

  let state = load();

  const elGameSeg = document.getElementById("gameSeg");
  const elHalf1 = document.getElementById("half1Btn");
  const elHalf2 = document.getElementById("half2Btn");
  const elNames = document.getElementById("names");
  const elTbody = document.getElementById("tbody");
  const elTotals = document.getElementById("totals");
  const elWherePill = document.getElementById("wherePill");

  const resetBack = document.getElementById("resetBack");
  document.getElementById("resetBtn").addEventListener("click", () => resetBack.style.display = "flex");
  document.getElementById("cancelReset").addEventListener("click", () => resetBack.style.display = "none");
  document.getElementById("confirmReset").addEventListener("click", () => {
    localStorage.removeItem(KEY);
    state = defaultState();
    resetBack.style.display = "none";
    save(); render();
  });
  resetBack.addEventListener("click", (e) => { if(e.target === resetBack) resetBack.style.display = "none"; });

  document.getElementById("newGameBtn").addEventListener("click", () => {
    state.games.push(makeGame());
    state.viewGame = state.games.length - 1;
    state.viewHalf = 1;
    save(); render();
  });

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);

      if(!Array.isArray(s.players) || s.players.length !== 4) s.players = defaultState().players;
      if(!Array.isArray(s.games) || s.games.length < 1) s.games = defaultState().games;

      s.viewGame = Number.isInteger(s.viewGame) ? Math.max(0, Math.min(s.viewGame, s.games.length-1)) : 0;
      s.viewHalf = (s.viewHalf === 2) ? 2 : 1;

      s.games = s.games.map(g => ({
        halves: {
          1: normalizeHalf(g?.halves?.["1"] || g?.halves?.[1]),
          2: normalizeHalf(g?.halves?.["2"] || g?.halves?.[2]),
        },
        orders: {
          1: Array.isArray(g?.orders?.["1"] || g?.orders?.[1]) ? (g.orders["1"] || g.orders[1]) : [0,1,2,3],
          2: Array.isArray(g?.orders?.["2"] || g?.orders?.[2]) ? (g.orders["2"] || g.orders[2]) : null
        }
      }));
      return s;
    }catch{
      return defaultState();
    }
  }

  function normalizeHalf(h){
    const def = makeHalf();
    if(!h || !Array.isArray(h.rounds) || h.rounds.length !== 11) return def;
    return {
      rounds: h.rounds.map(r => ({
        values: Array.isArray(r.values) ? r.values.slice(0,4).map(normVal) : [null,null,null,null],
        finalized: !!r.finalized,
        bidder: (Number.isInteger(r.bidder) && r.bidder>=0 && r.bidder<=3) ? r.bidder : null,
        bidAmount: normVal(r.bidAmount)
      }))
    };
  }

  function pname(i){
    const t = (state.players[i] || "").trim();
    return t.length ? t : `P${i+1}`;
  }
  function normVal(v){
    if(v === null || v === undefined || v === "") return null;
    const n = Number(v);
    if(!Number.isFinite(n)) return null;
    return Math.trunc(n);
  }
  function clamp013(v){
    if(v === null) return null;
    return Math.max(0, Math.min(13, v));
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function getGame(){ return state.games[state.viewGame]; }

  function getOrderForHalf(g, half){
    if(half === 1) return g.orders[1] || [0,1,2,3];
    return g.orders[2] || [0,1,2,3];
  }
  function realIndex(displayIdx){
    const g = getGame();
    const ord = getOrderForHalf(g, state.viewHalf);
    return ord[displayIdx];
  }

  function currentRounds(){
    return getGame().halves[state.viewHalf].rounds;
  }
  function roundComplete(values){
    return values.every(v => v !== null && v !== undefined);
  }
  function computeW(values, bidder, bidAmount){
    let nonSum = 0;
    for(let p=0;p<4;p++){
      if(p === bidder) continue;
      nonSum += (values[p] ?? 0);
    }
    return bidAmount + nonSum;
  }

  function displayForCell(r, pReal){
    const v = r.values[pReal];
    if(v === null) return { kind:"blank", text:"", score:0 };

    if(!r.finalized) return { kind:"num", text:String(v), score:v };

    if(r.bidder == null || r.bidAmount == null){
      return { kind:"num", text:String(v), score:v };
    }

    let bidderFailed = false;
    if(roundComplete(r.values)){
      const W = computeW(r.values, r.bidder, r.bidAmount);
      if(W > 13) bidderFailed = true;
    }

    if(pReal === r.bidder){
      if(bidderFailed) return { kind:"circ", text:String(r.bidAmount), score:-r.bidAmount };
      return { kind:"num", text:String(v), score:v };
    }

    if(v === 0){
      return { kind:"circ", text:String(r.bidAmount), score:-r.bidAmount };
    }

    return { kind:"num", text:String(v), score:v };
  }

  function totalsForHalf(game, half){
    const rounds = game.halves[half].rounds;
    const tot = [0,0,0,0];
    for(const r of rounds){
      for(let i=0;i<4;i++){
        const d = displayForCell(r, i);
        tot[i] += d.score;
      }
    }
    return tot;
  }
  function halfIsFinished(game, half){
    return game.halves[half].rounds.every(r => r.finalized);
  }
  function loserIndexHalf1(game){
    const t = totalsForHalf(game, 1);
    let loser = 0;
    for(let i=1;i<4;i++){
      if(t[i] < t[loser]) loser = i;
    }
    return loser;
  }
  function rotatedOrderStartingAt(startIdx){
    const base = [0,1,2,3];
    const pos = base.indexOf(startIdx);
    return base.slice(pos).concat(base.slice(0,pos));
  }

  function totalsForView(){
    const rounds = currentRounds();
    const tot = [0,0,0,0];
    for(const r of rounds){
      for(let p=0;p<4;p++){
        tot[p] += displayForCell(r, p).score;
      }
    }
    return tot;
  }
  function totalsUpTo10(){
    const rounds = currentRounds();
    const tot = [0,0,0,0];
    for(let i=0;i<10;i++){
      const r = rounds[i];
      for(let p=0;p<4;p++){
        tot[p] += displayForCell(r, p).score;
      }
    }
    return tot;
  }

  function activeRoundIndex(rounds){
    const i = rounds.findIndex(r => !r.finalized);
    return (i === -1) ? 10 : i;
  }
  function unfinalizeFrom(rounds, idx){
    for(let i=idx;i<rounds.length;i++) rounds[i].finalized = false;
  }

  function renderGameSeg(){
    elGameSeg.innerHTML = "";
    state.games.forEach((_, idx) => {
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = `G${idx+1}`;
      b.classList.toggle("active", idx === state.viewGame);
      b.addEventListener("click", () => {
        state.viewGame = idx;
        save(); render();
      });
      elGameSeg.appendChild(b);
    });
  }

  function clearRound(r){
    r.values = [null,null,null,null];
    r.finalized = false;
    r.bidder = null;
    r.bidAmount = null;
  }

  function render(){
    renderGameSeg();
    elHalf1.classList.toggle("active", state.viewHalf === 1);
    elHalf2.classList.toggle("active", state.viewHalf === 2);
    elWherePill.textContent = `G${state.viewGame+1} • ${state.viewHalf}/2`;

    // Names
    elNames.innerHTML = "";
    for(let i=0;i<4;i++){
      const inp = document.createElement("input");
      inp.className = "name";
      inp.type = "text";
      inp.placeholder = `Player ${i+1}`;
      inp.value = state.players[i] || "";
      inp.addEventListener("input", () => {
        state.players[i] = inp.value;
        for(let k=0;k<4;k++){
          const ri = realIndex(k);
          document.getElementById("h"+k).textContent = pname(ri);
        }
        save();
      });
      inp.addEventListener("blur", () => save());
      elNames.appendChild(inp);
    }

    // Headers
    for(let k=0;k<4;k++){
      const ri = realIndex(k);
      document.getElementById("h"+k).textContent = pname(ri);
    }

    const rounds = currentRounds();
    const activeIdx = activeRoundIndex(rounds);
    elTbody.innerHTML = "";

    for(let idx=0; idx<11; idx++){
      if(idx === 10){
        const rTotals = totalsUpTo10();
        const trR = document.createElement("tr");
        trR.className = "rrow";

        const tdLabel = document.createElement("td");
        tdLabel.className = "colN rlabel";
        tdLabel.textContent = "R";
        trR.appendChild(tdLabel);

        for(let k=0;k<4;k++){
          const ri = realIndex(k);
          const td = document.createElement("td");
          td.textContent = String(rTotals[ri]);
          trR.appendChild(td);
        }
        elTbody.appendChild(trR);
      }

      const roundNumber = idx + 1;
      const r = rounds[idx];

      const tr = document.createElement("tr");
      const tdN = document.createElement("td");
      tdN.className = "colN";
      tdN.textContent = String(roundNumber);
      tr.appendChild(tdN);

      const dealer = dealerOf(roundNumber);
      const opener = openerOf(roundNumber);
      const isActiveRound = (idx === activeIdx);
      const isEditableNow = (idx <= activeIdx);

      for(let k=0;k<4;k++){
        const ri = realIndex(k);
        const td = document.createElement("td");

        if(isActiveRound){
          if(k === dealer) td.classList.add("dealerCol");
          if(k === opener) td.classList.add("openerCol");
        }

        const cell = document.createElement("div");
        cell.className = "cell";

        const input = document.createElement("input");
        input.className = "scoreInput";
        input.type = "tel";
        input.inputMode = "numeric";
        input.pattern = "[0-9]*";
        input.autocomplete = "off";
        input.autocapitalize = "off";
        input.spellcheck = false;
        input.placeholder = "";
        input.value = (r.values[ri] === null) ? "" : String(r.values[ri]);

        // Lock future rounds
        if(!isEditableNow){
          cell.classList.add("disabled");
          input.disabled = true;
        }

        // On focus: allow editing and ensure it becomes active round for recalcs
        input.addEventListener("focus", () => {
          if(!isEditableNow) return;
          unfinalizeFrom(rounds, idx);
        });

        // On input: digits only + clamp, update bidder rules immediately
        input.addEventListener("input", () => {
          if(!isEditableNow) return;
          const raw = (input.value || "").replace(/[^\d]/g, "");
          input.value = raw;

          let val = raw === "" ? null : clamp013(Math.trunc(Number(raw)));
          if(val === null) r.values[ri] = null;
          else r.values[ri] = val;

          // bidder = first non-null entry in round (if not set)
          if(r.bidder == null && val != null){
            r.bidder = ri;
            r.bidAmount = val;
          }
          // if editing bidder cell, keep bidAmount synced
          if(r.bidder === ri){
            r.bidAmount = val;
          }

          // if all cleared, reset bidder info
          const any = r.values.some(x => x != null);
          if(!any){
            r.bidder = null;
            r.bidAmount = null;
          }

          save();
          // re-render to apply circles/score changes live
          render();
        });

        const circleWrap = document.createElement("div");
        circleWrap.className = "circleOverlay";

        const circle = document.createElement("div");
        circle.className = "circle";
        circleWrap.appendChild(circle);

        const dot = document.createElement("div");
        dot.className = "bidDot";

        // Apply display mode (circle vs number) if finalized
        const disp = displayForCell(r, ri);
        if(r.finalized && disp.kind === "circ"){
          circle.textContent = disp.text;
          circleWrap.style.display = "flex";
          input.style.opacity = "0";
          input.style.pointerEvents = "auto"; // still editable
        }else{
          circleWrap.style.display = "none";
          input.style.opacity = "1";
        }

        if(r.finalized && r.bidder === ri){
          dot.style.display = "block";
        }else{
          dot.style.display = "none";
        }

        cell.appendChild(input);
        cell.appendChild(circleWrap);
        cell.appendChild(dot);

        td.appendChild(cell);
        tr.appendChild(td);
      }

      elTbody.appendChild(tr);

      // Done row
      const trDone = document.createElement("tr");
      trDone.className = "doneRow";
      const tdDone = document.createElement("td");
      tdDone.colSpan = 5;

      const wrap = document.createElement("div");
      wrap.className = "doneWrap";

      const clearBtn = document.createElement("button");
      clearBtn.className = "miniBtn";
      clearBtn.type = "button";
      clearBtn.textContent = "Clear";
      clearBtn.disabled = !isActiveRound;
      clearBtn.addEventListener("click", () => {
        clearRound(r);
        save(); render();
      });

      const doneBtn = document.createElement("button");
      doneBtn.className = "btn";
      doneBtn.type = "button";
      doneBtn.textContent = "Done ✓";
      doneBtn.disabled = !(isActiveRound && r.bidder != null && r.bidAmount != null);
      doneBtn.addEventListener("click", () => {
        r.finalized = true;
        save(); render();
      });

      wrap.appendChild(clearBtn);
      wrap.appendChild(doneBtn);
      tdDone.appendChild(wrap);
      trDone.appendChild(tdDone);
      elTbody.appendChild(trDone);
    }

    // totals in current order
    const t = totalsForView();
    elTotals.innerHTML = "";
    for(let k=0;k<4;k++){
      const ri = realIndex(k);
      const b = document.createElement("div");
      b.className = "tbox";
      b.innerHTML = `
        <div class="tname">${escapeHtml(pname(ri))}</div>
        <div class="tval">${t[ri]}</div>
      `;
      elTotals.appendChild(b);
    }

    save();
  }

  elHalf1.addEventListener("click", () => {
    state.viewHalf = 1;
    save(); render();
  });

  elHalf2.addEventListener("click", () => {
    const g = getGame();
    if(!g.orders[2] && halfIsFinished(g, 1)){
      const loser = loserIndexHalf1(g);
      g.orders[2] = rotatedOrderStartingAt(loser);
    }
    state.viewHalf = 2;
    save(); render();
  });

  render();
})();
</script>
</body>
</html>
