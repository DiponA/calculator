<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Boja Calculator</title>
<style>
  :root{
    /* stable, calm palette (no scroll tinting) */
    --bg:#07070a;
    --panel: rgba(255,255,255,.045);
    --panel2: rgba(255,255,255,.06);
    --line: rgba(255,255,255,.09);
    --fg: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.60);

    --dealer: rgba(255,216,74,.95);
    --opener: rgba(107,255,138,.95);
    --danger: rgba(255,91,91,.95);

    --cellH: 44px;
    --topbarH: 56px;
    --r: 16px;
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height:100%; }
  body{
    margin:0;
    background: var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size:13px;
  }

  .wrap{ max-width:100%; margin:0 auto; padding:8px 8px 14px; }

  /* ---- Top bar ---- */
  .topbar{
    position:sticky; top:0; z-index:40;
    margin:-8px -8px 8px;
    padding:10px 10px calc(10px + env(safe-area-inset-top));
    background: rgba(10,10,14,.92);
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex; gap:8px; align-items:center;
  }
  .title{ font-weight:950; letter-spacing:.2px; font-size:14px; }
  .pill{
    font-size:11px; color:var(--muted);
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    padding:5px 9px;
    border-radius:999px;
    white-space:nowrap;
  }
  .sp{ flex:1; }
  .btn{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.05);
    color:var(--fg);
    padding:7px 11px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    user-select:none;
    font-size:12px;
    line-height:1;
  }
  .btn:active{ transform:translateY(1px); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }
  .btn.danger{ border-color: rgba(255,91,91,.35); }

  /* sticky controls under topbar */
  .stickyControls{
    position:sticky;
    top: var(--topbarH);
    z-index:35;
    margin-top:-6px;
    padding-top:6px;
    background: rgba(7,7,10,.92);
    border-bottom:1px solid rgba(255,255,255,.06);
  }

  .card{
    background: var(--panel);
    border:1px solid var(--line);
    border-radius: var(--r);
    padding:10px;
    box-shadow:
      0 10px 30px rgba(0,0,0,.28),
      inset 0 1px 0 rgba(255,255,255,.05);
  }
  .card + .card{ margin-top:8px; }

  .row{ display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }

  .seg{
    display:inline-flex;
    border:1px solid rgba(255,255,255,.10);
    border-radius:999px;
    overflow:hidden;
    background:rgba(255,255,255,.03);
  }
  .seg button{
    border:0;
    padding:7px 11px;
    background:transparent;
    color:var(--muted);
    font-weight:950;
    cursor:pointer;
    white-space:nowrap;
    font-size:12px;
  }
  .seg button.active{
    color:var(--fg);
    background:rgba(255,255,255,.08);
  }

  .names{
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:8px;
    margin-top:10px;
  }
  input.name{
    width:100%;
    border:1px solid rgba(255,255,255,.10);
    background: var(--panel2);
    color:var(--fg);
    border-radius: 14px;
    padding:10px 10px;
    font-weight:900;
    outline:none;
    font-size:13px;
    min-width:0;
  }
  input.name::placeholder{ color: rgba(255,255,255,.28); font-weight:900; }
  .name.loserMark{
    border-color: rgba(255,91,91,.45);
    box-shadow: inset 0 0 0 2px rgba(255,91,91,.14);
  }

  /* ---- Table ---- */
  table{
    width:100%;
    table-layout:fixed;
    border-collapse:separate;
    border-spacing:0;
    margin-top:10px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.09);
    border-radius: var(--r);
    font-size:12.5px;
    background: rgba(255,255,255,.02);
  }
  th, td{
    border-bottom:1px solid rgba(255,255,255,.07);
    border-right:1px solid rgba(255,255,255,.07);
    padding:7px 6px;
    text-align:center;
    vertical-align:middle;
  }
  tr:last-child td{ border-bottom:0; }
  th:last-child, td:last-child{ border-right:0; }
  th{
    color:rgba(255,255,255,.62);
    font-size:11.5px;
    font-weight:950;
    background: rgba(255,255,255,.03);
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  td{ background: rgba(0,0,0,.18); }
  .colN{ width:34px; color:rgba(255,255,255,.55); font-weight:950; font-size:11.5px; }

  /* turn highlights: border only (stable) */
  .dealerCol{ box-shadow: inset 0 0 0 2px rgba(255,216,74,.22); }
  .openerCol{ box-shadow: inset 0 0 0 2px rgba(107,255,138,.18); }

  .cell{
    position:relative;
    height:var(--cellH);
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.035);
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .scoreInput{
    width:100%;
    height:100%;
    border:0;
    outline:none;
    background:transparent;
    color:var(--fg);
    font-weight:950;
    font-size:14px;
    text-align:center;
    padding:0;
    margin:0;
    appearance:none;
    -webkit-appearance:none;
  }
  .scoreInput::placeholder{ color:rgba(255,255,255,.18); }

  .circleOverlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .circle{
    width:36px; height:36px;
    border-radius:999px;
    border:2px solid rgba(255,255,255,.80);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:950;
    font-size:12px;
    background: rgba(0,0,0,.10);
  }

  .bidDot{
    position:absolute;
    top:7px; right:7px;
    width:7px; height:7px;
    border-radius:999px;
    background:rgba(255,255,255,.9);
    opacity:.95;
    display:none;
    pointer-events:none;
  }

  .disabled{ opacity:.45; pointer-events:none; }

  .doneRow td{
    background: rgba(255,255,255,.02);
    padding:8px 8px;
  }
  .doneWrap{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  .miniBtn{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.045);
    color:var(--fg);
    padding:7px 11px;
    border-radius:999px;
    font-weight:950;
    cursor:pointer;
    font-size:12px;
    line-height:1;
  }
  .miniBtn:disabled{ opacity:.45; cursor:not-allowed; }

  .rrow td{
    background: rgba(255,255,255,.03);
    color: rgba(255,255,255,.62);
    font-weight:950;
  }
  .rlabel{
    font-weight:980;
    letter-spacing:.3px;
    color:rgba(255,255,255,.88);
  }

  .totalsRow{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap:8px;
  }
  .tbox{
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.09);
    border-radius: 16px;
    padding:10px 10px;
    min-width:0;
  }
  .tbox.loserMark{
    border-color: rgba(255,91,91,.45);
    box-shadow: inset 0 0 0 2px rgba(255,91,91,.14);
  }
  .tname{
    font-size:11.5px; color:rgba(255,255,255,.62); font-weight:950;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .tval{ margin-top:5px; font-size:18px; font-weight:980; letter-spacing:.2px; }

  /* reset sheet */
  .sheetBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:flex-end;
    justify-content:center;
    padding:10px 10px calc(10px + env(safe-area-inset-bottom));
    z-index:60;
  }
  .sheet{
    width:min(520px, 100%);
    background: rgba(18,18,24,.92);
    border:1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    padding:14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }
  .sheetTitle{ font-weight:980; font-size:14px; }
  .sheetText{ color:rgba(255,255,255,.62); font-size:12.5px; margin-top:6px; line-height:1.25; }
  .sheetRow{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; }

  @media (min-width: 900px){
    /* blur only on desktop (safe), not iOS */
    .topbar, .stickyControls{
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(10,10,14,.78);
    }
  }

  @media (min-width: 820px){
    .wrap{ max-width:980px; padding:14px 12px 40px; }
    .topbar{ margin:-14px -12px 12px; }
    .stickyControls{ margin-top:-12px; padding-top:12px; }
    :root{ --cellH: 54px; }
    .scoreInput{ font-size:16px; }
    .circle{ width:46px; height:46px; font-size:14px; }
    .tval{ font-size:24px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar" id="topbar">
    <div class="title">Boja calculator</div>
    <div class="pill" id="wherePill">G1 • 1/2</div>
    <div class="sp"></div>
    <button class="btn" id="newGameBtn">New</button>
    <button class="btn danger" id="resetBtn">Reset</button>
  </div>

  <div class="stickyControls">
    <div class="card">
      <div class="row">
        <div class="pill">Game</div>
        <div class="seg" id="gameSeg"></div>
        <div class="pill">Half</div>
        <div class="seg">
          <button type="button" id="half1Btn" class="active">1/2</button>
          <button type="button" id="half2Btn">2/2</button>
        </div>
      </div>
      <div class="names" id="names"></div>
    </div>
  </div>

  <div class="card">
    <table>
      <colgroup>
        <col style="width:34px">
        <col style="width:calc((100% - 34px)/4)">
        <col style="width:calc((100% - 34px)/4)">
        <col style="width:calc((100% - 34px)/4)">
        <col style="width:calc((100% - 34px)/4)">
      </colgroup>
      <thead>
        <tr>
          <th class="colN">#</th>
          <th id="h0">P1</th>
          <th id="h1">P2</th>
          <th id="h2">P3</th>
          <th id="h3">P4</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="totalsRow" id="totals"></div>
  </div>
</div>

<div class="sheetBack" id="resetBack">
  <div class="sheet">
    <div class="sheetTitle">Reset everything?</div>
    <div class="sheetText">This deletes all games and scores on this device.</div>
    <div class="sheetRow">
      <button class="btn" id="cancelReset">Cancel</button>
      <button class="btn danger" id="confirmReset">Reset</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  const KEY = "boja_calc_stable_colors_full_v1";

  function dealerOf(r){ return (r-1) % 4; }
  function openerOf(r){ return (dealerOf(r)+1) % 4; }

  function makeHalf(){
    return {
      rounds: Array.from({length:11}, () => ({
        values:[null,null,null,null],
        finalized:false,
        bidder:null,
        bidAmount:null
      }))
    };
  }

  function makeGame(){
    return {
      halves: { 1: makeHalf(), 2: makeHalf() },
      orders: { 1: [0,1,2,3], 2: null },
      losers: { 1: null, 2: null }
    };
  }

  function defaultState(){
    return {
      players: ["","","",""],
      games: [ makeGame() ],
      viewGame: 0,
      viewHalf: 1
    };
  }

  let state = load();

  const topbar = document.getElementById("topbar");
  const elGameSeg = document.getElementById("gameSeg");
  const elHalf1 = document.getElementById("half1Btn");
  const elHalf2 = document.getElementById("half2Btn");
  const elNames = document.getElementById("names");
  const elTbody = document.getElementById("tbody");
  const elTotals = document.getElementById("totals");
  const elWherePill = document.getElementById("wherePill");

  function syncTopbarH(){
    const h = topbar.offsetHeight || 56;
    document.documentElement.style.setProperty("--topbarH", h + "px");
  }
  window.addEventListener("resize", () => { syncTopbarH(); });

  const resetBack = document.getElementById("resetBack");
  document.getElementById("resetBtn").addEventListener("click", () => resetBack.style.display = "flex");
  document.getElementById("cancelReset").addEventListener("click", () => resetBack.style.display = "none");
  document.getElementById("confirmReset").addEventListener("click", () => {
    localStorage.removeItem(KEY);
    state = defaultState();
    resetBack.style.display = "none";
    save(); scheduleRender(true);
  });
  resetBack.addEventListener("click", (e) => { if(e.target === resetBack) resetBack.style.display = "none"; });

  document.getElementById("newGameBtn").addEventListener("click", () => {
    state.games.push(makeGame());
    state.viewGame = state.games.length - 1;
    state.viewHalf = 1;
    save(); scheduleRender(true);
  });

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);

      if(!Array.isArray(s.players) || s.players.length !== 4) s.players = defaultState().players;
      if(!Array.isArray(s.games) || s.games.length < 1) s.games = defaultState().games;

      s.viewGame = Number.isInteger(s.viewGame) ? Math.max(0, Math.min(s.viewGame, s.games.length-1)) : 0;
      s.viewHalf = (s.viewHalf === 2) ? 2 : 1;

      s.games = s.games.map(g => ({
        halves: {
          1: normalizeHalf(g?.halves?.["1"] || g?.halves?.[1]),
          2: normalizeHalf(g?.halves?.["2"] || g?.halves?.[2]),
        },
        orders: {
          1: Array.isArray(g?.orders?.["1"] || g?.orders?.[1]) ? (g.orders["1"] || g.orders[1]) : [0,1,2,3],
          2: Array.isArray(g?.orders?.["2"] || g?.orders?.[2]) ? (g.orders["2"] || g.orders[2]) : null
        },
        losers: {
          1: (Number.isInteger(g?.losers?.["1"] ?? g?.losers?.[1])) ? (g.losers["1"] ?? g.losers[1]) : null,
          2: (Number.isInteger(g?.losers?.["2"] ?? g?.losers?.[2])) ? (g.losers["2"] ?? g.losers[2]) : null
        }
      }));
      return s;
    }catch{
      return defaultState();
    }
  }

  function normalizeHalf(h){
    const def = makeHalf();
    if(!h || !Array.isArray(h.rounds) || h.rounds.length !== 11) return def;
    return {
      rounds: h.rounds.map(r => ({
        values: Array.isArray(r.values) ? r.values.slice(0,4).map(normVal) : [null,null,null,null],
        finalized: !!r.finalized,
        bidder: (Number.isInteger(r.bidder) && r.bidder>=0 && r.bidder<=3) ? r.bidder : null,
        bidAmount: normVal(r.bidAmount)
      }))
    };
  }

  function pname(i){
    const t = (state.players[i] || "").trim();
    return t.length ? t : `P${i+1}`;
  }
  function normVal(v){
    if(v === null || v === undefined || v === "") return null;
    const n = Number(v);
    if(!Number.isFinite(n)) return null;
    return Math.trunc(n);
  }
  function clamp013(v){
    if(v === null) return null;
    return Math.max(0, Math.min(13, v));
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function getGame(){ return state.games[state.viewGame]; }

  function getOrderForHalf(g, half){
    if(half === 1) return g.orders[1] || [0,1,2,3];
    return g.orders[2] || [0,1,2,3];
  }
  function realIndex(displayIdx){
    const g = getGame();
    const ord = getOrderForHalf(g, state.viewHalf);
    return ord[displayIdx];
  }

  function currentRounds(){
    return getGame().halves[state.viewHalf].rounds;
  }
  function roundComplete(values){
    return values.every(v => v !== null && v !== undefined);
  }
  function computeW(values, bidder, bidAmount){
    let nonSum = 0;
    for(let p=0;p<4;p++){
      if(p === bidder) continue;
      nonSum += (values[p] ?? 0);
    }
    return bidAmount + nonSum;
  }

  function displayForCell(r, pReal){
    const v = r.values[pReal];
    if(v === null) return { kind:"blank", text:"", score:0 };
    if(!r.finalized) return { kind:"num", text:String(v), score:v };

    if(r.bidder == null || r.bidAmount == null){
      return { kind:"num", text:String(v), score:v };
    }

    let bidderFailed = false;
    if(roundComplete(r.values)){
      const W = computeW(r.values, r.bidder, r.bidAmount);
      if(W > 13) bidderFailed = true;
    }

    if(pReal === r.bidder){
      if(bidderFailed) return { kind:"circ", text:String(r.bidAmount), score:-r.bidAmount };
      return { kind:"num", text:String(v), score:v };
    }

    if(v === 0){
      return { kind:"circ", text:String(r.bidAmount), score:-r.bidAmount };
    }

    return { kind:"num", text:String(v), score:v };
  }

  function totalsForHalf(game, half){
    const rounds = game.halves[half].rounds;
    const tot = [0,0,0,0];
    for(const r of rounds){
      for(let i=0;i<4;i++){
        tot[i] += displayForCell(r, i).score;
      }
    }
    return tot;
  }

  function totalsForView(){
    const rounds = currentRounds();
    const tot = [0,0,0,0];
    for(const r of rounds){
      for(let p=0;p<4;p++){
        tot[p] += displayForCell(r, p).score;
      }
    }
    return tot;
  }

  function totalsUpTo10(){
    const rounds = currentRounds();
    const tot = [0,0,0,0];
    for(let i=0;i<10;i++){
      const r = rounds[i];
      for(let p=0;p<4;p++){
        tot[p] += displayForCell(r, p).score;
      }
    }
    return tot;
  }

  function halfIsFinished(game, half){
    return game.halves[half].rounds.every(r => r.finalized);
  }

  function loserIndexForHalf(game, half){
    const t = totalsForHalf(game, half);
    let loser = 0;
    for(let i=1;i<4;i++){
      if(t[i] < t[loser]) loser = i;
    }
    return loser;
  }

  function rotatedOrderStartingAt(startIdx){
    const base = [0,1,2,3];
    const pos = base.indexOf(startIdx);
    return base.slice(pos).concat(base.slice(0,pos));
  }

  function activeRoundIndex(rounds){
    const i = rounds.findIndex(r => !r.finalized);
    return (i === -1) ? 10 : i;
  }
  function unfinalizeFrom(rounds, idx){
    for(let i=idx;i<rounds.length;i++) rounds[i].finalized = false;
  }

  function clearRound(r){
    r.values = [null,null,null,null];
    r.finalized = false;
    r.bidder = null;
    r.bidAmount = null;
  }

  function onHalfFinishedMaybeSetLoser(game, half){
    if(!halfIsFinished(game, half)) return;
    const loser = loserIndexForHalf(game, half);
    game.losers[half] = loser;
    if(half === 1 && !game.orders[2]){
      game.orders[2] = rotatedOrderStartingAt(loser);
    }
  }

  function renderGameSeg(){
    elGameSeg.innerHTML = "";
    state.games.forEach((_, idx) => {
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = `G${idx+1}`;
      b.classList.toggle("active", idx === state.viewGame);
      b.addEventListener("click", () => {
        state.viewGame = idx;
        save(); scheduleRender(true);
      });
      elGameSeg.appendChild(b);
    });
  }

  let renderQueued = false;
  let forceFull = false;
  function scheduleRender(full){
    forceFull = forceFull || !!full;
    if(renderQueued) return;
    renderQueued = true;
    requestAnimationFrame(() => {
      renderQueued = false;
      render(forceFull);
      forceFull = false;
    });
  }

  function render(){
    syncTopbarH();
    renderGameSeg();

    elHalf1.classList.toggle("active", state.viewHalf === 1);
    elHalf2.classList.toggle("active", state.viewHalf === 2);
    elWherePill.textContent = `G${state.viewGame+1} • ${state.viewHalf}/2`;

    const game = getGame();
    const loserForThisHalf = game.losers[state.viewHalf];
    const showLoserMark = (loserForThisHalf != null) && halfIsFinished(game, state.viewHalf);

    // Names
    elNames.innerHTML = "";
    for(let display=0; display<4; display++){
      const real = realIndex(display);
      const inp = document.createElement("input");
      inp.className = "name";
      inp.type = "text";
      inp.placeholder = `Player ${real+1}`;
      inp.value = state.players[real] || "";

      if(showLoserMark && real === loserForThisHalf) inp.classList.add("loserMark");

      inp.addEventListener("input", () => {
        state.players[real] = inp.value;
        for(let k=0;k<4;k++){
          const ri = realIndex(k);
          document.getElementById("h"+k).textContent = pname(ri);
        }
        save();
      });
      inp.addEventListener("blur", () => save());
      elNames.appendChild(inp);
    }

    for(let k=0;k<4;k++){
      const ri = realIndex(k);
      document.getElementById("h"+k).textContent = pname(ri);
    }

    const rounds = currentRounds();
    const activeIdx = activeRoundIndex(rounds);
    elTbody.innerHTML = "";

    for(let idx=0; idx<11; idx++){
      if(idx === 10){
        const rTotals = totalsUpTo10();
        const trR = document.createElement("tr");
        trR.className = "rrow";
        const tdLabel = document.createElement("td");
        tdLabel.className = "colN rlabel";
        tdLabel.textContent = "R";
        trR.appendChild(tdLabel);
        for(let k=0;k<4;k++){
          const ri = realIndex(k);
          const td = document.createElement("td");
          td.textContent = String(rTotals[ri]);
          trR.appendChild(td);
        }
        elTbody.appendChild(trR);
      }

      const roundNumber = idx + 1;
      const r = rounds[idx];

      const tr = document.createElement("tr");
      const tdN = document.createElement("td");
      tdN.className = "colN";
      tdN.textContent = String(roundNumber);
      tr.appendChild(tdN);

      const dealer = dealerOf(roundNumber);
      const opener = openerOf(roundNumber);
      const isActiveRound = (idx === activeIdx);
      const isEditableNow = (idx <= activeIdx);

      for(let display=0; display<4; display++){
        const real = realIndex(display);
        const td = document.createElement("td");

        if(isActiveRound){
          if(display === dealer) td.classList.add("dealerCol");
          if(display === opener) td.classList.add("openerCol");
        }

        const cell = document.createElement("div");
        cell.className = "cell";

        const input = document.createElement("input");
        input.className = "scoreInput";
        input.type = "tel";
        input.inputMode = "numeric";
        input.pattern = "[0-9]*";
        input.autocomplete = "off";
        input.autocapitalize = "off";
        input.spellcheck = false;
        input.placeholder = "";
        input.value = (r.values[real] === null) ? "" : String(r.values[real]);

        if(!isEditableNow){
          cell.classList.add("disabled");
          input.disabled = true;
        }

        input.addEventListener("focus", () => {
          if(!isEditableNow) return;
          unfinalizeFrom(rounds, idx);
        });

        input.addEventListener("input", () => {
          if(!isEditableNow) return;
          const raw = (input.value || "").replace(/[^\d]/g, "");
          input.value = raw;

          const val = raw === "" ? null : clamp013(Math.trunc(Number(raw)));
          r.values[real] = val;

          if(r.bidder == null && val != null){
            r.bidder = real;
            r.bidAmount = val;
          }
          if(r.bidder === real) r.bidAmount = val;

          const any = r.values.some(x => x != null);
          if(!any){
            r.bidder = null;
            r.bidAmount = null;
          }

          save();
          scheduleRender(false);
        });

        const circleWrap = document.createElement("div");
        circleWrap.className = "circleOverlay";

        const circle = document.createElement("div");
        circle.className = "circle";
        circleWrap.appendChild(circle);

        const dot = document.createElement("div");
        dot.className = "bidDot";

        const disp = displayForCell(r, real);
        if(r.finalized && disp.kind === "circ"){
          circle.textContent = disp.text;
          circleWrap.style.display = "flex";
          input.style.opacity = "0";
          input.style.pointerEvents = "auto";
        }else{
          circleWrap.style.display = "none";
          input.style.opacity = "1";
        }

        dot.style.display = (r.finalized && r.bidder === real) ? "block" : "none";

        cell.appendChild(input);
        cell.appendChild(circleWrap);
        cell.appendChild(dot);

        td.appendChild(cell);
        tr.appendChild(td);
      }

      elTbody.appendChild(tr);

      const trDone = document.createElement("tr");
      trDone.className = "doneRow";
      const tdDone = document.createElement("td");
      tdDone.colSpan = 5;

      const wrap = document.createElement("div");
      wrap.className = "doneWrap";

      const clearBtn = document.createElement("button");
      clearBtn.className = "miniBtn";
      clearBtn.type = "button";
      clearBtn.textContent = "Clear";
      clearBtn.disabled = !isActiveRound;
      clearBtn.addEventListener("click", () => {
        clearRound(r);
        save(); scheduleRender(true);
      });

      const doneBtn = document.createElement("button");
      doneBtn.className = "btn";
      doneBtn.type = "button";
      doneBtn.textContent = "Done ✓";
      doneBtn.disabled = !(isActiveRound && r.bidder != null && r.bidAmount != null);

      doneBtn.addEventListener("click", () => {
        r.finalized = true;
        if(idx === 10) onHalfFinishedMaybeSetLoser(game, state.viewHalf);
        save();
        scheduleRender(true);
      });

      wrap.appendChild(clearBtn);
      wrap.appendChild(doneBtn);
      tdDone.appendChild(wrap);
      trDone.appendChild(tdDone);
      elTbody.appendChild(trDone);
    }

    const t = totalsForView();
    elTotals.innerHTML = "";
    for(let display=0; display<4; display++){
      const real = realIndex(display);
      const b = document.createElement("div");
      b.className = "tbox";
      if(showLoserMark && real === loserForThisHalf) b.classList.add("loserMark");
      b.innerHTML = `
        <div class="tname">${escapeHtml(pname(real))}</div>
        <div class="tval">${t[real]}</div>
      `;
      elTotals.appendChild(b);
    }

    save();
  }

  // Half switching
  elHalf1.addEventListener("click", () => {
    state.viewHalf = 1;
    save(); scheduleRender(true);
  });

  elHalf2.addEventListener("click", () => {
    const g = getGame();
    if(!g.orders[2] && halfIsFinished(g, 1)){
      const loser = (g.losers[1] != null) ? g.losers[1] : loserIndexForHalf(g, 1);
      g.orders[2] = rotatedOrderStartingAt(loser);
    }
    state.viewHalf = 2;
    save(); scheduleRender(true);
  });

  scheduleRender(true);
})();
</script>
</body>
</html>